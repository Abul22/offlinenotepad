<!doctype html>
<html lang=en-US>

<head>
    <meta charset='utf-8'>
    <title>The Air Horner</title>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='description' content='An Air horn. Probably the best air horn web app there is.'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='canonical' href='https://airhorner.com/'>
    <link rel='manifest' href='manifest.json'>
    <meta name='mobile-web-app-capable' content='yes'>
    <meta name='apple-mobile-web-app-capable' content='yes'>
    <meta name='application-name' content='Air Horner'>
    <meta name='apple-mobile-web-app-status-bar-style' content='black'>
    <meta name='apple-mobile-web-app-title' content='Air Horner'>
    <link rel='icon' sizes='192x192' href='/images/touch/Airhorner_192.png'>
    <link rel='apple-touch-icon' href='/images/touch/Airhorner_192.png'>
    <meta name='msapplication-TileImage' content='/images/touch/Airhorner_144.png'>
    <meta name='msapplication-TileColor' content='#2196F3'>
    <meta name='theme-color' content='#2196F3'>
    <meta property='og:title' content='Air Horn'>
    <meta property='og:type' content='website'>
    <meta property='og:image' content='https://airhorner.com/images/touch/Airhorner_192.png'>
    <meta property='og:url' content='https://airhorner.com/'>
    <meta property='og:description'
        content='The best and easiest Air Horn web app there is. No install just use it right away in your browser!'>
    <meta name='twitter:card' content='summary'>
    <meta name='twitter:url' content='https://airhorner.com/'>
    <meta name='twitter:title' content='Air Horn'>
    <meta name='twitter:description'
        content='The best and easiest Air Horn web app there is. No install just use it right away in your browser!'>
    <meta name='twitter:image' content='https://airhorner.com/images/touch/Airhorner_192.png'>
    <meta name='twitter:creator' content='@paul_kinlan'>
    <link rel='stylesheet' href='style.css'>
    <script src='/js/pwacompat.min.js' async></script>
</head>

<body>

    <main>

        <span class="fr fonty">
            <a id='listlink'>List</a><br>
            <a id='viewlink'>View</a><br>
            <a id='editlink'>Edit</a>
        </span>
        <div class="fonty" id="rendered">

        </div>

        <textarea class="writing" id="editable" style="-webkit-user-select:text;display:none;" rows=110
            placeholder="Click here and start writing" autofocus>
# this is a test
 
*some test*
        </textarea>

        <!-- <div id='installer'>
            <button class='button'>Install</button>
        </div> -->
    </main>


    <script src="/js/lz-string.js"></script>
    <script src="/js/pako.min.js"></script>
    <script src="/js/crypto-js.min.js"></script>
    <script src="/js/enc-utf16.min.js"></script>
    <script src="/js/lunr.min.js"></script>
    <script src="/js/localforage.js"></script>
    <script src="/js/showdown.min.js"></script>
    <!-- <script>
        /* code for the service worker */
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js', {
                    scope: '/'
                })
                .then(function (registration) {
                    console.log('Service Worker Registered');
                });
            navigator.serviceWorker.ready.then(function (registration) {
                console.log('Service Worker Ready');
            });
        }
    </script> -->
    <script>
        /* generic functions */
        // replace all function
        String.prototype.replaceAll = function (search, replacement) {
            var target = this;
            return target.replace(new RegExp(search, 'g'), replacement);
        };


        /* initiate local storage with password */
        // Feel free to change the drivers order :)
        localforage.setDriver([
            localforage.INDEXEDDB,
            localforage.WEBSQL,
            localforage.LOCALSTORAGE
        ]).then(function () {
            localforage.getItem('passwordcombo').then(function (readValue) {
                if (readValue == null) {
                    var newPassword = prompt("Choose a passphrase for encryption:");
                    localforage.setItem('passwordcombo', newPassword, function () {
                        console.log("password set");
                    });
                }
            });
        });

        var CY = {};
        CY.debounce = function (func, wait, immediate) {
            var timeout;
            return function () {
                var context = this,
                    args = arguments;
                var later = function () {
                    timeout = null;
                    if (!immediate) {
                        func.apply(context, args);
                    }
                };
                var callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait || 200);
                if (callNow) {
                    func.apply(context, args);
                }
            };
        };


        // Constructor function for Person objects
        // a = new Document("HI");
        Document = function (title) {
            this.title = title;
            this.hash = CryptoJS.SHA256(title).toString();
            this.created = new Date();
            this.modified = new Date();
            this.markdown = "";
        }


        a = new Document("HI");
        CY.updateDocument(a);

        CY.updateDocument = function (doc) {
            localforage.getItem('passwordcombo').then(function (passwordValue) {
                if (passwordValue != null) {
                    encoded = encode(JSON.stringify(doc), passwordValue);
                    console.log(encoded);
                    localforage.setItem(doc.hash, encoded, function () {
                        console.log(`uploaded ${encoded.length} bytes for '${doc.title}'`)
                    });
                };
            });
        };

        CY.getDocument = function (doc_hash) {
            localforage.getItem('passwordcombo').then(function (passwordValue) {
                if (passwordValue != null) {
                    localforage.getItem(doc_hash).then(function (getValue) {
                        doc = JSON.parse(decode(getValue, passwordValue));
                        console.log(doc);
                    });
                };
            });
        };

        CY.contentEdited = function () {
            // console.log('edited');
            var markdown = document.getElementById("editable").value.replaceAll("<br>", "\n");
            c = new showdown.Converter()
            document.getElementById("rendered").innerHTML = c.makeHtml(markdown);
        };
        document.getElementById("editable").addEventListener('input', CY.debounce(CY.contentEdited, 200));


        CY.loadEditor = function () {
            document.getElementById("rendered").style.display = 'none'; // needed to add brs at end
            document.getElementById("editable").style.display = 'inline-block'; // needed to add brs at end
            document.getElementById("editable").focus();
            // autoExpand(document.getElementById("editable"));
        };

        CY.hideEditor = function () {
            document.getElementById("editable").style.display = 'none'; // needed to add brs at end
            document.getElementById("rendered").style.display = 'inline-block'; // needed to add brs at end
        };


        editlink = document.getElementById("editlink")
        if (editlink != null) {
            editlink.addEventListener("click", CY.loadEditor);
        }
        viewlink = document.getElementById("viewlink")
        if (viewlink != null) {
            viewlink.addEventListener("click", CY.hideEditor);
        }



        var documents = [{
            "name": "Lunr",
            "text": "Like Solr, but much smaller, and not as bright."
        }, {
            "name": "React",
            "text": "A JavaScript library for building user interfaces."
        }, {
            "name": "Lodash",
            "text": "A modern JavaScript utility library delivering modularity, performance & extras."
        }]
        var idx = lunr(function () {
            this.ref('name')
            this.field('text')

            documents.forEach(function (doc) {
                this.add(doc)
            }, this)
        })

        idx.search("bright")





        // Encrypt
        var ciphertext = CryptoJS.AES.encrypt('my message', 'secret key 123');

        // Decrypt
        var bytes = CryptoJS.AES.decrypt(ciphertext.toString(), 'secret key 123');
        var plaintext = bytes.toString(CryptoJS.enc.Utf8);


        // compression 
        str =
            "üòÄ üòÅ üòÇ ü§£ üòÉ üòÑ üòÖ üòÜ üòâ üòä üòã üòé üòç The passage experienced a surge in popularity during the 1960s when Letraset used it on their dry-transfer sheets, and again during the 90s as desktop publishers bundled the text with their software. Today it's seen all around the web; on templates, websites, and stock designs. Use our generator to get your own, or read on for the authoritative history of lorem ipsum.  There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration in some form, by injected humour, or randomised words which don't look even slightly believable. If you are going to use a passage of Lorem Ipsum, you need to be sure there isn't anything embarrassing hidden in the middle of text. All the Lorem Ipsum generators on the Internet tend to repeat predefined chunks as necessary, making this the first true generator on the Internet. It uses a dictionary of over 200 Latin words, combined with a handful of model sentence structures, to generate Lorem Ipsum which looks reasonable. The generated Lorem Ipsum is therefore always free from repetition, injected humour, or non-characteristic words etc."
        c = btoa(pako.deflate(str, {
            to: 'string',
            level: 6,
        }));
        d = pako.inflate(atob(c), {
            to: 'string'
        })
        console.log(str.length)
        console.log(c.length)
        console.log(d);





        var compressed = LZString.compressToUTF16(str);
        console.log("Size of compressed sample is: " + compressed.length);
        localStorage.setItem("myData", compressed);


        localforage.setItem("test1", compressed, function () {
            localforage.getItem("test1").then(function (readValue) {
                string = LZString.decompressFromUTF16(readValue);
                console.log("Sample is: " + string);
            });
        });


        ciphertext = CryptoJS.AES.encrypt(LZString.compressToBase64(str), 'secret key 123');
        console.log(ciphertext.toString().length)
        bytes = CryptoJS.AES.decrypt(ciphertext.toString(), 'secret key 123');
        plaintext = bytes.toString(CryptoJS.enc.Utf8);
        console.log(LZString.decompressFromBase64(plaintext));


        wordArray = CryptoJS.enc.Utf16.parse(LZString.compressToUTF16(str))
        ciphertext = CryptoJS.AES.encrypt(wordArray, 'secret key 123');
        console.log(ciphertext.toString().length)
        localforage.setItem("test2", ciphertext.toString(), function () {
            localforage.getItem("test2").then(function (readValue) {
                bytes = CryptoJS.AES.decrypt(readValue, 'secret key 123');
                plaintext = bytes.toString(CryptoJS.enc.Utf16);
                console.log(LZString.decompressFromUTF16(plaintext))
            });
        });



        postData('/', {
                t: "ping",
            })
            .then(data => console.log(JSON.stringify(data))) // JSON-string from `response.json()` call
            .catch(error => console.log('error: ' + error));

        function postData(url = '', data = {}) {
            // Default options are marked with *
            return fetch(url, {
                    method: 'POST', // *GET, POST, PUT, DELETE, etc.
                    mode: 'same-origin', // no-cors, cors, *same-origin
                    cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                    credentials: 'same-origin', // include, *same-origin, omit
                    headers: {
                        'Content-Type': 'application/json',
                        // 'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    redirect: 'follow', // manual, *follow, error
                    referrer: 'no-referrer', // no-referrer, *client
                    body: JSON.stringify(data), // body data type must match "Content-Type" header
                })
                .then(response => response.json()); // parses JSON response into native Javascript objects 
        }



        localforage.keys().then(function (keys) {
            keys.forEach(function (key) {
                switch (key) {
                    case "passwordcombo":
                        return
                    default:
                        if (key.length == 64) {
                            // filter hashes
                            console.log("hash: " + key)
                        }
                }
            });
        }).catch(function (err) {
            // This code runs if there were any errors
            console.log(err);
        });





        var keySize = 256;
        var ivSize = 128;
        var iterations = 100;

        // http://www.adonespitogo.com/articles/encrypting-data-with-cryptojs-aes/

        function encode(msgString, pass) {
            msg = CryptoJS.enc.Utf16.parse(LZString.compressToUTF16(msgString))
            var salt = CryptoJS.lib.WordArray.random(128 / 8);

            var key = CryptoJS.PBKDF2(pass, salt, {
                keySize: keySize / 32,
                iterations: iterations
            });

            var iv = CryptoJS.lib.WordArray.random(128 / 8);

            var encrypted = CryptoJS.AES.encrypt(msg, key, {
                iv: iv,
                padding: CryptoJS.pad.Pkcs7,
                mode: CryptoJS.mode.CBC

            });

            // salt, iv will be hex 32 in length
            // append them to the ciphertext for use  in decryption
            var transitmessage = salt.toString() + iv.toString() + encrypted.toString();
            return transitmessage;
        }

        function decode(transitmessage, pass) {
            if (transitmessage == null) {
                console.log("got null transmit message")
                return null;
            }
            var salt = CryptoJS.enc.Hex.parse(transitmessage.substr(0, 32));
            var iv = CryptoJS.enc.Hex.parse(transitmessage.substr(32, 32))
            var encrypted = transitmessage.substring(64);

            var key = CryptoJS.PBKDF2(pass, salt, {
                keySize: keySize / 32,
                iterations: iterations
            });

            var decrypted = CryptoJS.AES.decrypt(encrypted, key, {
                iv: iv,
                padding: CryptoJS.pad.Pkcs7,
                mode: CryptoJS.mode.CBC

            })
            return LZString.decompressFromUTF16(decrypted.toString(CryptoJS.enc.Utf16));
        }

        enc = encode(str, "password");
        console.log(enc)
        console.log(enc.length);
        console.log(decode(enc, "password"))
    </script>
</body>

</html>